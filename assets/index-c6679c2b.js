import{r as e,a as t,b as r,R as n}from"./vendor-e9025187.js";import{d as c,a as s,b as o,l as a,n as l,c as i,r as u,e as d,i as h,f as p,g as m,h as f}from"./utils-9de47014.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const r of e)if("childList"===r.type)for(const e of r.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var x={exports:{}},g={},v=e,w=Symbol.for("react.element"),y=Symbol.for("react.fragment"),C=Object.prototype.hasOwnProperty,E=v.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,N={key:!0,ref:!0,__self:!0,__source:!0};function b(e,t,r){var n,c={},s=null,o=null;for(n in void 0!==r&&(s=""+r),void 0!==t.key&&(s=""+t.key),void 0!==t.ref&&(o=t.ref),t)C.call(t,n)&&!N.hasOwnProperty(n)&&(c[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===c[n]&&(c[n]=t[n]);return{$$typeof:w,type:e,key:s,ref:o,props:c,_owner:E.current}}g.Fragment=y,g.jsx=b,g.jsxs=b,x.exports=g;var j=x.exports,S={},T=t;S.createRoot=T.createRoot,S.hydrateRoot=T.hydrateRoot;const k=e.forwardRef((({audioSrc:t,onEnded:r,onPlayStateChange:n,checkCapitalization:c=!1,onToggleCapitalization:s=()=>{},onPrevious:o=()=>{},onNext:a=()=>{},onCancel:l=()=>{},onRepeat:i=()=>{}},u)=>{const[d,h]=e.useState(!1),[p,m]=e.useState(0),[f,x]=e.useState(0),[g,v]=e.useState(!1),[w,y]=e.useState(1),C=e.useRef(null),E=e.useRef(0),N=e.useRef(!1),b=e.useRef(null),S=e.useRef(null);e.useEffect((()=>{h(!1),m(0),x(0),v(!1),b.current&&(b.current.pause(),b.current.currentTime=0,b.current.load())}),[t]),e.useImperativeHandle(u,(()=>({play:()=>{b.current&&g&&(N.current=!1,b.current.play())},pause:()=>{b.current&&b.current.pause()},stop:()=>{b.current&&(b.current.pause(),b.current.currentTime=0)},seekTo:e=>!(!b.current||!g)&&(E.current=e,b.current.currentTime=e,m(e),N.current=!1,!0),setCurrentSentenceEndTime:e=>{C.current=e,N.current=!1,console.log("Set sentence end time to:",e)},getCurrentTime:()=>b.current?b.current.currentTime:0,getDuration:()=>b.current?b.current.duration:0,repeatSentence:()=>!(!b.current||!g)&&(N.current=!1,b.current.currentTime=E.current,null===C.current&&console.warn("No end time set for sentence repeat"),b.current.play(),!0)})));const T=e=>{const t=Math.floor(e/60),r=Math.floor(e%60);return`${t}:${r<10?"0":""}${r}`},k=()=>{const e=b.current&&!b.current.paused;h(e),n&&n(e)};return j.jsxs("div",{className:"audio-player",children:[j.jsx("audio",{ref:b,src:t,onTimeUpdate:()=>{if(b.current){const e=b.current.currentTime;if(m(e),null!==C.current&&e>=C.current&&!N.current&&(console.log("Reached sentence end time:",C.current,"current time:",e),N.current=!0,b.current.pause(),h(!1),n&&n("paused"),r)){const e=C.current;C.current=null,setTimeout((()=>{b.current&&Math.abs(b.current.currentTime-e)<.5&&r()}),50)}}},onLoadedMetadata:()=>{b.current&&(x(b.current.duration),v(!0))},onEnded:()=>{h(!1),b.current&&b.current.pause(),r&&setTimeout((()=>{r()}),50)},onPlay:k,onPause:k,loop:!1}),j.jsxs("div",{className:"player-container",children:[j.jsxs("div",{className:"controls-left",children:[j.jsx("button",{className:"control-button",onClick:()=>{if(o)o();else{if(!g)return;b.current.currentTime=Math.max(0,b.current.currentTime-5)}},disabled:!g,title:"Previous Sentence",children:j.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:j.jsx("path",{d:"M15 18l-6-6 6-6"})})}),j.jsx("button",{className:"play-button",onClick:()=>{g&&(d?(b.current.pause(),n&&n("paused")):(n&&n("playing"),b.current.play()))},disabled:!g,children:d?j.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:[j.jsx("rect",{x:"6",y:"4",width:"4",height:"16"}),j.jsx("rect",{x:"14",y:"4",width:"4",height:"16"})]}):j.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:j.jsx("polygon",{points:"5,3 19,12 5,21"})})}),j.jsx("button",{className:"control-button",onClick:()=>{if(a)a();else{if(!g)return;b.current.currentTime=Math.min(b.current.duration,b.current.currentTime+5)}},disabled:!g,title:"Next Sentence",children:j.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:j.jsx("path",{d:"M9 18l6-6-6-6"})})})]}),j.jsxs("div",{className:"progress-wrapper",children:[j.jsxs("div",{className:"progress-bar-container",children:[j.jsx("div",{className:"progress-bar",ref:S,onClick:e=>{if(!g||!S.current)return;const t=S.current.getBoundingClientRect(),r=(e.clientX-t.left)/t.width;b.current.currentTime=r*b.current.duration},children:j.jsx("div",{className:"progress-fill",style:{width:`${p/f*100||0}%`}})}),j.jsxs("div",{className:"time-display",children:[T(p)," / ",T(f)]})]}),j.jsxs("div",{className:"controls-right",children:[j.jsx("button",{className:"option-toggle "+(c?"active":""),onClick:s,title:"Case Sensitivity: "+(c?"Strict (Hard Mode)":"Relaxed (Normal Mode)"),children:"Aa"}),j.jsx("button",{className:"option-toggle",onClick:i,title:"Repeat Sentence",children:j.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[j.jsx("path",{d:"M23 4v6h-6"}),j.jsx("path",{d:"M1 20v-6h6"}),j.jsx("path",{d:"M3.51 9a9 9 0 0 1 14.85-3.36L23 10"}),j.jsx("path",{d:"M20.49 15a9 9 0 0 1-14.85 3.36L1 14"})]})}),j.jsx("button",{onClick:()=>{let e;e=1===w?.75:.75===w?.5:1,b.current&&(b.current.playbackRate=e),y(e)},className:"playback-speed-button",children:1===w?"100%":.75===w?"75%":"50%"}),j.jsx("button",{className:"cancel-button",onClick:e=>{if(e.preventDefault(),e.stopPropagation(),console.log("Cancel button clicked in AudioPlayer"),"function"==typeof l)console.log("Calling onCancel prop"),l();else{console.log("Dispatching custom cancelDictation event");const e=new CustomEvent("dictationCancel");document.dispatchEvent(e)}},title:"Cancel exercise",children:j.jsx("span",{children:"✕"})})]})]})]})]})})),L=({isOpen:e,title:t="Confirm Action",message:r="Are you sure?",confirmText:n="Confirm",cancelText:c="Cancel",onConfirm:s,onCancel:o})=>e?j.jsx("div",{className:"confirm-dialog-overlay",children:j.jsxs("div",{className:"confirm-dialog",children:[j.jsx("h3",{className:"confirm-dialog-title",children:t}),j.jsx("p",{className:"confirm-dialog-message",children:r}),j.jsxs("div",{className:"confirm-dialog-buttons",children:[j.jsx("button",{className:"confirm-dialog-button confirm",onClick:s,children:n}),j.jsx("button",{className:"confirm-dialog-button cancel",onClick:o,children:c})]})]})}):null,R=({content:e,position:t,onClose:n})=>r.createPortal(j.jsx("div",{className:"word-tooltip",style:{left:`${t.left}px`,top:`${t.top}px`},onClick:n,children:e}),document.body),M=({dictationResults:t,sentenceResults:r,totalTime:i=0,onRestart:u})=>{const[d,h]=e.useState(null),[p,m]=e.useState({top:0,left:0}),[f,x]=e.useState(""),g=e=>!!e&&(!!/[äöüÄÖÜß]/.test(e)||!!/a\/|ae|a:|o\/|oe|o:|u\/|ue|u:|s\//.test(e)),v=(e,t)=>{if(!e||!t)return 0;const r=l(e.toLowerCase()),n=l(t.toLowerCase());if(r===n)return 1;let c=1-a(r,n)/Math.max(r.length,n.length);return(g(e)||g(t))&&(c=Math.min(1,1.2*c)),c},w=e.useMemo((()=>{c("CALC_STATS",{hasDictationResults:!!t,sentenceResultsLength:null==r?void 0:r.length});const e=r.length,n=r.filter(Boolean).length;let o=t.totalWordsInAllText||0,a=0,l=0,i=0;r.forEach(((e,r)=>{if(e){const r=e.actual.split(/\s+/).filter(Boolean),n=e.expected.split(/\s+/).filter(Boolean);a+=r.length;let c=0;const o=new Set;r.forEach((e=>{for(let r=0;r<n.length;r++){if(o.has(r))continue;const a=n[r];if(s(e,a,t.checkCapitalization)){o.add(r),c++;break}}})),l+=c,i+=r.length-c}}));return{totalWords:o,completedWords:a,correctWords:l,incorrectWords:i,percentageCompleted:o>0?a/o*100:0,accuracyPercentage:a>0?l/a*100:0,totalSentences:e,completedSentences:n}}),[t,r]);e.useEffect((()=>{const e=e=>{!d||e.target.closest(".word-tooltip")||e.target.closest(".word-incorrect")||h(null)};return document.addEventListener("click",e),()=>document.removeEventListener("click",e)}),[d]);const y=()=>j.jsx("div",{className:"side-by-side-comparison",children:j.jsxs("div",{className:"comparison-column",children:[j.jsx("h3",{children:"Your Text"}),j.jsx("div",{className:"text-container",children:r.map(((e,t)=>j.jsx("div",{className:"sentence-row",children:e?j.jsx(C,{userText:e.actual,expectedText:e.expected,sentenceIndex:t}):j.jsx("div",{className:"sentence-placeholder",children:j.jsx("span",{className:"skipped-indicator",children:"Not attempted"})})},t)))})]})}),C=({userText:r,expectedText:c,sentenceIndex:l})=>{if(!r)return j.jsx("div",{className:"empty-text",children:"(No text)"});const i=e.useRef({}),u=r.split(/\s+/).filter(Boolean),p=c.split(/\s+/).filter(Boolean),f=o(p,u,t.checkCapitalization),g=(e,t)=>{if(d===e)return void h(null);const r=i.current[e];if(r){const n=r.getBoundingClientRect();m({left:n.left+n.width/2,top:n.top-10});const c=(e=>{if(!e)return null;let t=null,r=0;for(const n of p)if(n.toLowerCase()===e.toLowerCase())return n;for(const n of p)if(Math.abs(n.length-e.length)<=2&&a(n.toLowerCase(),e.toLowerCase())<=(n.length<=3?1:2))return n;for(const n of p){const c=v(e,n);c>r&&c>.6&&(r=c,t=n)}return t})(t);x(c||"Extra word"),h(e)}},w=f.map(((e,r)=>{var n;let c="",o=`word-${l}-${r}`,a=e.user,u=!1;"match"===e.op?u=!0:"sub"===e.op&&e.ref&&e.user&&(u=s(e.user,e.ref,t.checkCapitalization)),u?(c="word-correct",!t.checkCapitalization&&e.ref&&e.user&&e.ref.toLowerCase()===e.user.toLowerCase()&&e.ref!==e.user&&(a=e.ref)):"sub"===e.op||"ins"===e.op?c="word-incorrect":"del"===e.op&&(c="word-placeholder",a="_".repeat(e.ref.length));const d=u?{color:"var(--text-light)",textDecoration:"none",backgroundColor:"transparent"}:{color:"var(--incorrect)",textDecoration:"sub"===e.op||"ins"===e.op?"line-through":"none",position:"relative",backgroundColor:"rgba(255, 82, 82, 0.1)"};return j.jsx("span",{className:c,style:d,onClick:u||a==="_".repeat((null==(n=e.ref)?void 0:n.length)||0)?void 0:()=>g(o,a),ref:e=>i.current[o]=e,children:a},r)}));return j.jsx("div",{className:"user-sentence-wrapper",children:j.jsx("div",{className:"user-sentence",children:w.map(((e,t)=>j.jsx(n.Fragment,{children:e},t)))})})};return j.jsxs("div",{className:"dictation-feedback","data-screen":"results",children:[j.jsx("h2",{children:"Dictation Results"}),void 0!==t.score&&j.jsxs("div",{className:"score-display",children:[j.jsx("div",{className:"score-value",children:t.score}),j.jsx("div",{className:"score-label",children:"Score"}),t.maxHintLevelUsed>0&&j.jsxs("div",{className:"hint-penalty-info",children:[j.jsx("span",{className:"hint-icon",children:"💡"}),j.jsxs("span",{className:"hint-text",children:["Hint penalty: ",Math.round(100*(1-t.hintPenaltyMultiplier)),"%"]})]})]}),j.jsxs("div",{className:"feedback-stats",children:[j.jsxs("div",{className:"stat-item",children:[j.jsx("div",{className:"stat-title",children:"Completion"}),j.jsxs("div",{className:"stat-value",children:[Math.round(w.percentageCompleted),"%"]}),j.jsxs("div",{className:"stat-detail",children:[w.completedWords," / ",w.totalWords," words"]})]}),j.jsxs("div",{className:"stat-item",children:[j.jsx("div",{className:"stat-title",children:"Accuracy"}),j.jsxs("div",{className:"stat-value",children:[Math.round(w.accuracyPercentage),"%"]}),j.jsxs("div",{className:"stat-detail",children:[w.correctWords," correct words"]})]}),j.jsxs("div",{className:"stat-item",children:[j.jsx("div",{className:"stat-title",children:"Mistakes"}),j.jsxs("div",{className:"stat-value",children:[w.incorrectWords," / ",w.completedWords]}),j.jsxs("div",{className:"stat-detail",children:["(",w.completedWords>0?Math.round(w.incorrectWords/w.completedWords*100):0,"%)"]})]}),j.jsxs("div",{className:"stat-item",children:[j.jsx("div",{className:"stat-title",children:"Time"}),j.jsx("div",{className:"stat-value",children:(e=>{const t=Math.floor(e/60),r=Math.floor(e%60);return`${t}:${r<10?"0":""}${r}`})(i)}),j.jsxs("div",{className:"stat-detail",children:[w.totalWords>0?Math.round(w.completedWords/(i/60)*10)/10:0," words/min"]})]})]}),j.jsx(y,{}),d&&j.jsx(R,{content:f,position:p,onClose:()=>h(null)}),j.jsx("button",{className:"restart-button",onClick:u,children:"New Dictation"})]})},P=({expected:e,actual:t,checkCapitalization:r=!1})=>{if(!e)return null;t||(t=""),i(e,r);const n=e.split(/\s+/),c=t.split(/\s+/),s=(e,t,r)=>{const n=[];if(!e||!t)return n;if(r&&e&&t&&e.toLowerCase()===t.toLowerCase()){for(let r=0;r<t.length;r++){const c=e[r],s=t[r],o=c===s;0===r&&c===c.toUpperCase()&&s.toLowerCase();n.push({type:o?"char-correct":"char-incorrect",text:s})}return n}if(e&&t&&e.toLowerCase().includes(t.toLowerCase())){const c=t.toLowerCase(),s=e.toLowerCase().indexOf(c);for(let t=0;t<s;t++){const r=e[t];n.push({type:"char-placeholder",text:p(r)?r:"_"})}for(let o=0;o<t.length;o++){const c=e[s+o],a=t[o],l=r?c===a:c.toLowerCase()===a.toLowerCase();n.push({type:l?"char-correct":"char-incorrect",text:a})}for(let r=s+t.length;r<e.length;r++){const t=e[r];n.push({type:"char-placeholder",text:p(t)?t:"_"})}return n}if(e&&t&&t.toLowerCase().includes(e.toLowerCase())){const c=t.toLowerCase(),s=e.toLowerCase(),o=c.indexOf(s);for(let e=0;e<o;e++)n.push({type:"char-extra",text:t[e]});for(let a=0;a<e.length;a++){const c=e[a],s=t[o+a],l=r?c===s:c.toLowerCase()===s.toLowerCase();n.push({type:l?"char-correct":"char-incorrect",text:s})}for(let r=o+e.length;r<t.length;r++)n.push({type:"char-extra",text:t[r]});return n}i(e,r),i(t,r);const c=e.split(""),s=t.split("");let o=0,a=0;for(;o<c.length;){const e=c[o];if(p(e)){a<s.length&&e===s[a]?(n.push({type:"char-correct",text:e}),a++):n.push({type:"char-placeholder",text:e}),o++;continue}if(a>=s.length){const e=c[o];n.push({type:"char-placeholder",text:p(e)?e:"_"}),o++;continue}const t=s[a];if(p(t)){n.push({type:"char-incorrect",text:t}),a++;continue}if(r?e===t:e.toLowerCase()===t.toLowerCase())n.push({type:"char-correct",text:t}),o++,a++;else{const e=3;let l=!1;for(let t=1;t<=e&&a+t<s.length;t++)if(r&&c[o]===s[a+t]||!r&&c[o].toLowerCase()===s[a+t].toLowerCase()){for(let e=0;e<t;e++)n.push({type:"char-incorrect",text:s[a+e]});a+=t,l=!0;break}if(!l)for(let t=1;t<=e&&o+t<c.length;t++)if(r&&c[o+t]===s[a]||!r&&c[o+t].toLowerCase()===s[a].toLowerCase()){for(let e=0;e<t;e++)n.push({type:"char-placeholder",text:"_"}),o++;l=!0;break}l||(n.push({type:"char-incorrect",text:t}),a++,o++)}}for(;a<s.length;)n.push({type:"char-extra",text:s[a]}),a++;return n},o=(()=>{const e=[];let t=0;for(let o=0;o<n.length;o++){const l=n[o],u=i(l,r);if(t>=c.length)e.push({type:"missing",text:l});else{let o=null,p=-1,m=Math.min(5,c.length-t);for(let e=0;e<m;e++){const n=c[t+e],s=i(n,r);let m=0;if(r){const e=i(n,!0),t=i(l,!0);if(e===t)m=1;else if(e.toLowerCase()===t.toLowerCase())m=l.charAt(0)===l.charAt(0).toUpperCase()&&n.charAt(0)!==n.charAt(0).toUpperCase()?.75:.95;else if(d(e.toLowerCase(),t.toLowerCase())){m=.6+.3*(1-a(e.toLowerCase(),t.toLowerCase())/Math.max(e.length,t.length))}}else s===u&&(m=1);if(m<.9&&h(n,l)&&(m=.85),m<.8&&d(r?l:u,r?n:s)){m=.5+.4*(1-a(r?l:u,r?n:s)/Math.max((r?l:u).length,(r?n:s).length))}else if(m<.5){const e=r?l:u,t=r?n:s,c=Math.min(e.length,t.length);let o=0;for(let r=0;r<c;r++)e[r]===t[r]&&o++;m=o/Math.max(e.length,t.length)}if(m<.8&&("in"===l.toLowerCase()||"ihr"===l.toLowerCase()||"ist"===l.toLowerCase()||"es"===l.toLowerCase()||"der"===l.toLowerCase()||"die"===l.toLowerCase()||"das"===l.toLowerCase())&&n.toLowerCase()===l.toLowerCase()&&(m=.95),m>.4){const t=r?.01*e:.03*e;m=Math.max(.4,m-t)}if(m>p&&(p=m,o={index:t+e,word:n,score:m}),m>.95)break}const f=.38;if(o&&o.score>f){for(let r=t;r<o.index;r++)e.length<2*n.length-1&&(e.push({type:"extra",text:c[r]}),r<o.index-1&&e.push({type:"space",text:" "}));o.score>=.9?e.push({type:"correct",text:l}):e.push({type:"partial",chars:s(l,o.word,r)}),t=o.index+1}else e.push({type:"missing",text:l})}o<n.length-1&&e.push({type:"space",text:" "})}for(;t<c.length;)e.length>0&&"space"!==e[e.length-1].type&&e.push({type:"space",text:" "}),e.push({type:"extra",text:c[t]}),t++;return e})();return j.jsx("div",{className:"character-feedback",children:o.map(((e,t)=>{var r;switch(e.type){case"correct":return j.jsx("span",{className:"word-correct",children:e.text},t);case"partial":return j.jsx("span",{className:"word-partial",children:e.chars.map(((e,t)=>{switch(e.type){case"char-correct":return j.jsx("span",{className:"char-correct",children:e.text},t);case"char-incorrect":return j.jsx("span",{className:"char-incorrect",children:e.text},t);case"char-placeholder":return j.jsx("span",{className:"char-placeholder",children:e.text},t);case"char-extra":return j.jsx("span",{className:"char-extra",children:e.text},t);default:return null}}))},t);case"missing":return j.jsx("span",{className:"word-missing",children:"_".repeat(u(e.text).length)},t);case"extra":const n=t>0&&"space"!==(null==(r=o[t-1])?void 0:r.type);return j.jsxs("span",{className:"word-extra",children:[n&&" ",e.text]},t);case"space":return j.jsx("span",{className:"word-space",children:e.text},t);default:return null}}))})},I=[{id:1,title:"Chapter 1",audio:"/audio/chap01.mp3",vttFile:"/audio/chap01.vtt",level:"Intermediate"}],A=e.forwardRef((({exerciseId:t=1,isMobile:r=!1,hideShortcuts:n=!1,audioPlayerOverride:s=null,customExercise:a=null},l)=>{const i=I.find((e=>e.id===t))||I[0],[u,d]=e.useState(i),[h,p]=e.useState(""),[m,f]=e.useState([]),[x,g]=e.useState(0),[v,w]=e.useState(!1),[y,C]=e.useState(!0),[E,N]=e.useState([]),[b,S]=e.useState(!1),[T,R]=e.useState(!1),[A,D]=e.useState(!1),[_,O]=e.useState(0),[W,B]=e.useState(!1),[z,F]=e.useState(!0),[H,U]=e.useState(!1),[X,$]=e.useState(!1),[Y,K]=e.useState(!1),[q,V]=e.useState(!1),[G,J]=e.useState(0),[Q,Z]=e.useState(null),[ee,te]=e.useState(null),re=e.useRef(null),ne=e.useRef(null),ce=e.useRef(null),se=e.useRef(null),oe=e.useRef(0);e.useEffect((()=>{oe.current=x}),[x]),e.useEffect((()=>{}),[_]),e.useEffect((()=>{}),[x,A,b,v,W]),e.useEffect((()=>{const e=navigator.platform.includes("Mac");R(e)}),[]),e.useEffect((()=>{if(a)d(a);else{const e=I.find((e=>e.id===t))||I[0];d(e)}}),[t,a]),e.useEffect((()=>{C(!0),f([]),g(0),oe.current=0,p(""),N([]),S(!1),O(0),B(!1),F(!1),V(!1),J(0),Z(null),fetch(u.vttFile).then((e=>{if(!e.ok)throw new Error("Network response was not ok");return e.text()})).then((e=>{const t=ae(e);f(t),C(!1)})).catch((e=>{console.error("Error loading VTT file:",e),C(!1)}))}),[u]),e.useEffect((()=>(b&&Q&&!q&&(se.current&&clearInterval(se.current),se.current=setInterval((()=>{const e=Math.floor((Date.now()-Q)/1e3);J(e)}),1e3)),()=>{se.current&&clearInterval(se.current)})),[b,Q,q]),e.useEffect((()=>()=>{ce.current&&clearTimeout(ce.current),se.current&&clearInterval(se.current)}),[]),e.useEffect((()=>{b&&ne.current&&(v||setTimeout((()=>{ne.current&&!v&&(ne.current.focus(),console.log("[FOCUS]","Input field focused after audio stopped"),B(!0))}),100))}),[v,b]),e.useEffect((()=>{const e=e=>{var t;if(y)return;if(T?e.metaKey:e.ctrlKey)switch(e.key){case"Enter":e.preventDefault(),v?null==(t=re.current)||t.pause():b?ie():fe();break;case"ArrowLeft":e.preventDefault(),b&&de();break;case"ArrowRight":e.preventDefault(),b&&pe(!0);break;case"ArrowUp":e.preventDefault(),b?ie():fe()}};return document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)}}),[b,y,v,x,T,A]);const ae=e=>{const t=e.split("\n"),r=[];let n={text:"",startTime:0,endTime:0};for(let c=0;c<t.length;c++){const e=t[c].trim();if(e.includes("--\x3e")){const t=e.split("--\x3e").map((e=>e.trim()));n={startTime:le(t[0]),endTime:le(t[1]),text:""}}else""===e||"WEBVTT"===e||e.includes("--\x3e")||(n.text=e,r.push({...n}))}return r},le=e=>{const t=e.split(":");let r=0;return 3===t.length?r=3600*parseFloat(t[0])+60*parseFloat(t[1])+parseFloat(t[2]):2===t.length&&(r=60*parseFloat(t[0])+parseFloat(t[1])),r},ie=(e=null)=>{const t=null!==e?e:oe.current;if(0===m.length||t>=m.length||A)return;ce.current&&(clearTimeout(ce.current),ce.current=null),B(!1),w(!0);const r=m[t];if(re.current){c("PLAY_SENTENCE","Playing sentence at index:",t,"starting at time:",r.startTime,"ending at:",r.endTime);try{re.current.pause(),re.current.seekTo(r.startTime),re.current.setCurrentSentenceEndTime(r.endTime),re.current.play()}catch(n){console.error("Error in audio playback:",n),w(!1)}}},ue=()=>{if(re.current&&m.length>0){c("REPEAT_SENTENCE","Repeating current sentence",{currentIndex:oe.current,sentencesLength:m.length});const e=m[oe.current];e?(re.current.pause(),B(!1),w(!0),re.current.repeatSentence?re.current.repeatSentence():(re.current.seekTo(e.startTime),re.current.setCurrentSentenceEndTime(e.endTime),re.current.play()),console.log("Playing sentence again from time:",e.startTime,"to",e.endTime)):console.warn("No current sentence found for repeat")}else console.warn("Audio player not initialized or no sentences available")},de=()=>{if(x>0&&!A){D(!0),B(!1),""!==h.trim()&&he(),re.current&&v&&re.current.pause(),ce.current&&(clearTimeout(ce.current),ce.current=null);const e=x-1;g(e),oe.current=e,setTimeout((()=>{p(""),ie(e),D(!1)}),100)}},he=()=>{if(x>=m.length)return!1;const e=m[x],t=(e,t=!1)=>{let r=e;return r=r.replace(/oe/g,"ö").replace(/o\//g,"ö").replace(/o:/g,"ö").replace(/ae/g,"ä").replace(/a\//g,"ä").replace(/a:/g,"ä").replace(/ue/g,"ü").replace(/u\//g,"ü").replace(/u:/g,"ü").replace(/s\//g,"ß"),"schoener"===r.toLowerCase()&&(r="schöner"),"schoen"===r.toLowerCase()&&(r="schön"),"felle"===r.toLowerCase()&&(r="fälle"),r=r.replace(/[^\p{L}\p{N}\s]/gu,"").replace(/\s+/g," ").trim(),t||(r=r.toLowerCase()),r},r=t(e.text,X),n=t(h,X),s=r===n,o=[...E];return o[x]={expected:e.text,actual:h,isCorrect:s},N(o),c("PROCESS_INPUT",{expected:r,actual:n,isCorrect:s,resultsLength:o.filter(Boolean).length,checkingCapitalization:X}),s},pe=(e=!1)=>{if(A)return;if(x>=m.length-1&&!e)return""!==h.trim()&&he(),ge(),V(!0),w(!1),void g(m.length);if(x>=m.length-1&&e){D(!0),B(!1),F(!1),""!==h.trim()&&he(),re.current&&v&&re.current.pause();const e=0;return g(e),oe.current=e,void setTimeout((()=>{p(""),ie(e),D(!1),console.log("[NEXT SENTENCE SHORTCUT]","Looped back to first sentence")}),100)}D(!0),B(!1),F(!1),""!==h.trim()&&he(),re.current&&v&&re.current.pause(),ce.current&&(clearTimeout(ce.current),ce.current=null);const t=x+1;g(t),oe.current=t,setTimeout((()=>{p(""),ie(t),D(!1),console.log("[NEXT SENTENCE SHORTCUT]","Navigation completed")}),100)},me=()=>{c("NEXT_SENTENCE","Button clicked/Enter pressed, attempting to go to next sentence",{userInput:h.trim(),navigationInProgress:A,currentSentenceIndex:x,waitingForInput:W});const e=0===x;if(""===h.trim()&&!e||A)c("NEXT_SENTENCE","Blocked - empty input or navigation in progress",{inputEmpty:""===h.trim(),navigationInProgress:A,forceProcess:e});else if(""===h.trim())if(x<m.length-1){console.log("[NEXT_SENTENCE]","Moving to next sentence (no userInput)"),D(!0),B(!1),re.current&&v&&re.current.pause(),ce.current&&(clearTimeout(ce.current),ce.current=null);const e=x+1;g(e),oe.current=e,setTimeout((()=>{p(""),ie(e),D(!1),console.log("[NEXT_SENTENCE]","Navigation completed (no userInput)")}),100)}else console.log("[NEXT_SENTENCE]","Exercise completed! (no userInput branch)"),B(!1),ge(),V(!0),g(m.length);else if(he(),x<m.length-1){console.log("[NEXT_SENTENCE]","Moving to next sentence"),D(!0),B(!1),re.current&&v&&re.current.pause(),ce.current&&(clearTimeout(ce.current),ce.current=null);const e=x+1;g(e),oe.current=e,setTimeout((()=>{p(""),ie(e),D(!1),console.log("[NEXT_SENTENCE]","Navigation completed")}),100)}else console.log("[NEXT_SENTENCE]","Exercise completed! (userInput branch)"),B(!1),ge(),V(!0),g(m.length)},fe=()=>{m.length>0&&(g(0),oe.current=0,N([]),p(""),S(!0),O(0),B(!1),setTimeout((()=>{ne.current&&ne.current.focus()}),100)),Z(Date.now()),setTimeout((()=>{ie(0)}),100)};e.useEffect((()=>()=>{re.current&&re.current.pause(),ce.current&&(clearTimeout(ce.current),ce.current=null)}),[u]);const xe=()=>{console.log("handleCancelExercise called in DictationTool"),Ee()},ge=()=>{const e=m.length,t=[...E];for(;t.length<m.length;)t.push(null);const r=m.flatMap((e=>e.text.split(/\s+/).filter(Boolean))),n=t.filter(Boolean).flatMap((e=>e.actual.split(/\s+/).filter(Boolean))),c=o(r,n,X);let s=0,a=0,l=0,i=0,u=0;c.forEach((e=>{"match"===e.op?s++:"sub"===e.op?(a++,u++):"ins"===e.op?(a++,l++):"del"===e.op&&(a++,i++)}));const d={totalSentences:e,completedSentences:t.filter(Boolean).length,referenceWords:r,userWords:n,correct:s,mistakes:a,insertions:l,deletions:i,substitutions:u,totalWordsInAllText:r.length};te(d)},ve=()=>{V(!1),ce.current&&(clearTimeout(ce.current),ce.current=null),g(0),oe.current=0,N([]),p(""),w(!1),S(!1),D(!1),O(0),B(!1),F(!1)},we=x>=m.length&&b&&E.length>0;e.useEffect((()=>{we&&!q&&(se.current&&clearInterval(se.current),ge(),V(!0))}),[we,q]);const ye=T?"⌘":"Ctrl",Ce=m[x];E[x],e.useEffect((()=>{q&&!ee&&ge()}),[q,ee]),e.useImperativeHandle(l,(()=>({startExercise:fe,cancelExercise:xe,handlePreviousSentence:de,goToNextSentence:pe,repeatCurrentSentence:ue,togglePlayPause:Ne,changePlaybackSpeed:be,getCurrentSpeed:je,audioRef:re,getAudioElement:()=>re.current})));e.useEffect((()=>{const e=()=>{console.log("Caught dictationCancel event in DictationTool"),Ee()};return document.addEventListener("dictationCancel",e),()=>{document.removeEventListener("dictationCancel",e)}}),[]);const Ee=()=>{console.log("openConfirmDialog called"),K(!0)},Ne=()=>{console.log("Toggling play/pause"),re.current&&(v?re.current.pause():re.current.play())},be=()=>{if(console.log("Changing playback speed"),re.current){const e=re.current.playbackRate;re.current.playbackRate=e>=1?.75:e>=.75?.5:1}},je=()=>re.current?Math.round(100*re.current.playbackRate):100;return y?j.jsx("div",{className:"loading",children:"Loading exercise..."}):q?ee?j.jsx(M,{dictationResults:ee,sentenceResults:E,totalTime:G,onRestart:ve}):j.jsx("div",{className:"loading",children:"Loading results..."}):j.jsxs("div",{className:"dictation-tool",children:[j.jsx("div",{className:"audio-section",children:j.jsx(k,{audioSrc:u.audio,ref:re,onPlayStateChange:e=>{"playing"===e?(w(!0),b||fe()):"paused"===e&&w(!1)},checkCapitalization:X,onToggleCapitalization:()=>$((e=>!e)),onEnded:()=>(console.log("Audio ended for current sentence"),ce.current&&(clearTimeout(ce.current),ce.current=null),w(!1),B(!0),void setTimeout((()=>{ne.current&&(ne.current.disabled=!1,ne.current.focus())}),100)),onPrevious:de,onNext:()=>pe(!0),onCancel:()=>{console.log("handleAudioCancel called from AudioPlayer"),Ee()},onRepeat:ue})}),j.jsx(L,{isOpen:Y,title:"End Dictation Exercise",message:"Are you sure you want to end this dictation exercise? Your progress will be saved and results will be shown.",confirmText:"End Exercise",cancelText:"Continue Exercise",onConfirm:()=>{K(!1),""!==h.trim()&&he(),re.current&&re.current.pause(),ce.current&&(clearTimeout(ce.current),ce.current=null),se.current&&(clearInterval(se.current),se.current=null),ge(),V(!0),w(!1)},onCancel:()=>{K(!1)}}),!n&&j.jsxs("div",{className:"keyboard-shortcuts-info",children:[j.jsx("button",{className:"shortcuts-toggle",onClick:()=>{U((e=>!e))},children:"Keyboard Shortcuts"}),j.jsxs("div",{className:"shortcuts-panel "+(H?"show":""),children:[j.jsxs("div",{className:"shortcut-row",children:[j.jsxs("div",{className:"shortcut-keys",children:[j.jsx("kbd",{children:ye})," + ",j.jsx("kbd",{children:"Enter"})]}),j.jsx("div",{className:"shortcut-description",children:": Play/Pause"})]}),j.jsxs("div",{className:"shortcut-row",children:[j.jsxs("div",{className:"shortcut-keys",children:[j.jsx("kbd",{children:ye})," + ",j.jsx("kbd",{children:"←"})]}),j.jsx("div",{className:"shortcut-description",children:": Previous sentence"})]}),j.jsxs("div",{className:"shortcut-row",children:[j.jsxs("div",{className:"shortcut-keys",children:[j.jsx("kbd",{children:ye})," + ",j.jsx("kbd",{children:"→"})]}),j.jsx("div",{className:"shortcut-description",children:": Next sentence"})]}),j.jsxs("div",{className:"shortcut-row",children:[j.jsxs("div",{className:"shortcut-keys",children:[j.jsx("kbd",{children:ye})," + ",j.jsx("kbd",{children:"↑"})]}),j.jsx("div",{className:"shortcut-description",children:": Repeat sentence"})]})]})]}),we?null:j.jsx("div",{className:"input-section",children:b?j.jsxs(j.Fragment,{children:[Ce&&j.jsx("div",{className:"feedback-container real-time",children:j.jsx(P,{expected:Ce.text,actual:h,checkCapitalization:X})}),j.jsx("div",{className:"dictation-input-area",children:j.jsx("textarea",{ref:ne,className:"dictation-input "+(v?"is-playing":"is-waiting"),value:h,onChange:e=>{let t=e.target.value;t=t.replace(/oe/g,"ö").replace(/o\//g,"ö").replace(/o:/g,"ö").replace(/ae/g,"ä").replace(/a\//g,"ä").replace(/a:/g,"ä").replace(/ue/g,"ü").replace(/u\//g,"ü").replace(/u:/g,"ü").replace(/s\//g,"ß"),p(t)},onKeyDown:e=>{const t=T?e.metaKey:e.ctrlKey;v||"Enter"!==e.key||t||A||v||(e.preventDefault(),O((e=>e+1)),me())},placeholder:"Type what you hear, then press Enter...",disabled:!1,autoFocus:!0})})]}):j.jsx("div",{className:"start-section",children:j.jsx("div",{className:"start-instructions",children:"Press play to start"})})})]})})),D=t=>{e.useEffect((()=>{const e=()=>{try{const e=document.body.scrollHeight;window.parent.postMessage({type:"DICTATION_HEIGHT_UPDATE",height:e},"*"),console.log("Sent height update to parent:",e)}catch(e){console.error("Error sending height to parent:",e)}};setTimeout(e,500);const t=setInterval(e,1e3),r=new ResizeObserver((()=>{e()}));return r.observe(document.body),()=>{clearInterval(t),r.disconnect()}}),[]);const r={...t,hideShortcuts:!1,showDebugInfo:!0};return j.jsx(A,{...r})},_=e.createContext(),O=({children:t})=>{const[r,n]=e.useState("undefined"!=typeof window&&window.innerWidth<=768);return e.useEffect((()=>{const e=window.matchMedia("(max-width: 768px)");n(e.matches);const t=e=>{n(e.matches)};return e.addEventListener("change",t),()=>e.removeEventListener("change",t)}),[]),e.useEffect((()=>{const e=()=>{setDeviceType({isMobile:window.matchMedia("(max-width: 767px)").matches,isTablet:window.matchMedia("(min-width: 768px) and (max-width: 1023px)").matches,isDesktop:window.matchMedia("(min-width: 1024px)").matches})};return window.addEventListener("orientationchange",e),window.addEventListener("resize",e),()=>{window.removeEventListener("orientationchange",e),window.removeEventListener("resize",e)}}),[]),j.jsx(_.Provider,{value:{isMobile:r},children:t})},W=({children:t})=>{const r=e.useRef(null),n=e.useRef(null);return e.useEffect((()=>{const e=e=>{1===e.touches.length&&(r.current={x:e.touches[0].clientX,y:e.touches[0].clientY,time:Date.now()},n.current=r.current)},t=e=>{1===e.touches.length&&(n.current={x:e.touches[0].clientX,y:e.touches[0].clientY,time:Date.now()})},c=e=>{if(!r.current||!n.current)return;const t=n.current.x-r.current.x,c=n.current.y-r.current.y,s=Math.abs(t),o=Math.abs(c);s<40&&o<40||(s>o?t<0?window.dispatchEvent(new CustomEvent("mobile-swipe-left")):window.dispatchEvent(new CustomEvent("mobile-swipe-right")):c<0?window.dispatchEvent(new CustomEvent("mobile-swipe-up")):window.dispatchEvent(new CustomEvent("mobile-swipe-down")),r.current=null,n.current=null)};return document.addEventListener("touchstart",e,{passive:!0}),document.addEventListener("touchmove",t,{passive:!0}),document.addEventListener("touchend",c,{passive:!0}),()=>{document.removeEventListener("touchstart",e),document.removeEventListener("touchmove",t),document.removeEventListener("touchend",c)}}),[]),j.jsx("div",{className:"mobile-gesture-handler",children:t})},B=e.forwardRef((({customExercise:t,...r},n)=>{const c=e.useRef(null);return e.useImperativeHandle(n,(()=>({startExercise:()=>{c.current&&c.current.startExercise&&c.current.startExercise()},cancelExercise:()=>{console.log("Cancel exercise called via ref"),c.current&&c.current.cancelExercise&&c.current.cancelExercise()},goToNextSentence:e=>{c.current&&c.current.goToNextSentence&&c.current.goToNextSentence(e)},handlePreviousSentence:()=>{c.current&&c.current.handlePreviousSentence&&c.current.handlePreviousSentence()},repeatCurrentSentence:()=>{console.log("Repeating current sentence from ref"),c.current&&c.current.repeatCurrentSentence?c.current.repeatCurrentSentence():c.current&&c.current.audioRef&&c.current.audioRef.current&&(c.current.audioRef.current.currentTime=0,c.current.audioRef.current.play())},togglePlayPause:()=>{if(console.log("Toggling play/pause from ref"),c.current&&c.current.togglePlayPause)c.current.togglePlayPause();else if(c.current&&c.current.audioRef&&c.current.audioRef.current){const e=c.current.audioRef.current;e.paused?e.play():e.pause()}},pauseAudio:()=>{c.current&&c.current.pauseAudio?c.current.pauseAudio():c.current&&c.current.audioRef&&c.current.audioRef.current&&c.current.audioRef.current.pause()},changePlaybackSpeed:()=>{if(c.current&&c.current.changePlaybackSpeed)c.current.changePlaybackSpeed();else if(c.current&&c.current.audioRef&&c.current.audioRef.current){const e=c.current.audioRef.current,t=e.playbackRate;e.playbackRate=t>=1?.75:t>=.75?.5:1}},getCurrentSpeed:()=>{if(c.current&&c.current.getCurrentSpeed)return c.current.getCurrentSpeed();if(c.current&&c.current.audioRef&&c.current.audioRef.current){const e=c.current.audioRef.current.playbackRate;return Math.round(100*e)}return 100},getAudioElement:()=>c.current&&c.current.audioRef&&c.current.audioRef.current?c.current.audioRef.current:null}))),j.jsx(A,{...r,customExercise:t,ref:c})})),z=e.forwardRef(((t,r)=>{const{audioSrc:n,onEnded:c,onPlayStateChange:s,onCancel:o=()=>{}}=t,[a,l]=e.useState(!1),[i,u]=e.useState(0),[d,h]=e.useState(0),[p,m]=e.useState(!1),[f,x]=e.useState(1),g=e.useRef(null),v=e.useRef(0),w=e.useRef(!1),y=e.useRef(null);e.useEffect((()=>{l(!1),u(0),h(0),m(!1),y.current&&(y.current.pause(),y.current.currentTime=0,y.current.load())}),[n]),e.useImperativeHandle(r,(()=>({play:()=>{y.current&&p&&(w.current=!1,y.current.play())},pause:()=>{y.current&&y.current.pause()},stop:()=>{y.current&&(y.current.pause(),y.current.currentTime=0)},seekTo:e=>!(!y.current||!p)&&(v.current=e,y.current.currentTime=e,u(e),w.current=!1,!0),setCurrentSentenceEndTime:e=>{g.current=e,w.current=!1,console.log("Set sentence end time to:",e)},getCurrentTime:()=>y.current?y.current.currentTime:0,getDuration:()=>y.current?y.current.duration:0,repeatSentence:()=>!(!y.current||!p)&&(w.current=!1,y.current.currentTime=v.current,null===g.current&&console.warn("No end time set for sentence repeat"),y.current.play(),!0)})));const C=()=>{const e=y.current&&!y.current.paused;l(e),s&&s(e)};return j.jsxs("div",{className:"mobile-audio-player",children:[j.jsx("audio",{ref:y,src:n,onTimeUpdate:()=>{if(y.current){const e=y.current.currentTime;if(u(e),null!==g.current&&e>=g.current&&!w.current&&(console.log("Reached sentence end time:",g.current,"current time:",e),w.current=!0,y.current.pause(),l(!1),c)){const e=g.current;g.current=null,setTimeout((()=>{y.current&&Math.abs(y.current.currentTime-e)<.5&&c()}),50)}}},onLoadedMetadata:()=>{y.current&&(h(y.current.duration),m(!0))},onEnded:()=>{l(!1),y.current&&y.current.pause(),c&&setTimeout((()=>{c()}),50)},onPlay:C,onPause:C,loop:!1}),j.jsxs("div",{className:"mobile-player-container",children:[j.jsx("button",{className:"mobile-play-button",onClick:()=>{p&&(a?(y.current.pause(),s&&s("paused")):(s&&s("playing"),y.current.play()))},disabled:!p,children:a?j.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:[j.jsx("rect",{x:"6",y:"4",width:"4",height:"16"}),j.jsx("rect",{x:"14",y:"4",width:"4",height:"16"})]}):j.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:j.jsx("polygon",{points:"5,3 19,12 5,21"})})}),j.jsxs("button",{className:"mobile-playback-speed-button",onClick:()=>{const e=[.75,1,1.25,1.5],t=(e.indexOf(f)+1)%e.length;x(e[t]),y.current&&(y.current.playbackRate=e[t])},children:[f,"x"]}),j.jsx("button",{className:"cancel-button",onClick:()=>{if(console.log("Cancel button clicked in MobileAudioPlayer"),"function"==typeof t.onCancel)console.log("Calling onCancel from props"),t.onCancel();else{console.error("No onCancel handler provided");const e=new CustomEvent("dictationCancel");document.dispatchEvent(e)}},title:"Cancel exercise",children:j.jsx("span",{children:"✕"})})]}),j.jsx("div",{className:"mobile-progress-bar",children:j.jsx("div",{className:"mobile-progress-fill",style:{width:`${i/d*100||0}%`}})})]})})),F={container:{position:"fixed",top:0,left:0,right:0,bottom:0,overflow:"hidden",width:"100vw",height:"100vh",touchAction:"none",backgroundColor:"#000"},content:{height:"100%",overflow:"hidden",display:"flex",flexDirection:"column",maxWidth:"100vw",maxHeight:"100vh"},indicators:{position:"fixed",bottom:"20px",left:0,right:0,display:"flex",justifyContent:"center",alignItems:"center",zIndex:100,pointerEvents:"none"},indicator:{display:"flex",alignItems:"center",margin:"0 10px",padding:"8px 12px",backgroundColor:"rgba(0, 0, 0, 0.7)",borderRadius:"20px",color:"white"},icon:{marginRight:"8px",fontSize:"18px"},feedback:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",backgroundColor:"rgba(0, 0, 0, 0.8)",color:"white",padding:"15px 20px",borderRadius:"10px",zIndex:1e3,opacity:1,pointerEvents:"none"}},H=t=>{const[r,n]=e.useState(!1),[c,s]=e.useState(null),o=e.useRef(null),a=e.useRef(null),l=e.useRef(0),i=e.useRef(0),u=e.useRef(null),d=e=>{s(e),u.current&&clearTimeout(u.current),u.current=setTimeout((()=>{s(null)}),1500)};e.useEffect((()=>{const e=a.current,t=e=>{if(document.querySelector('.dictation-feedback[data-screen="results"]'))return;let t=e.target;for(;t&&t!==document;){if(t.tagName&&"textarea"===t.tagName.toLowerCase())return;if(t.classList&&t.classList.contains("dictation-feedback"))return;t=t.parentNode}e.preventDefault()};return e&&(e.addEventListener("touchmove",t,{passive:!1}),document.body.addEventListener("touchmove",t,{passive:!1}),document.body.style.overflow="hidden",document.documentElement.style.overflow="hidden"),()=>{e&&(e.removeEventListener("touchmove",t),document.body.removeEventListener("touchmove",t),document.body.style.overflow="",document.documentElement.style.overflow="")}}),[]);const h=()=>{o.current&&o.current.startExercise&&(o.current.startExercise(),n(!0))},p=()=>{console.log("Direct cancel handler in MobileDictationTool"),o.current&&o.current.cancelExercise&&(console.log("Calling cancelExercise on dictationToolRef"),o.current.cancelExercise())};e.useEffect((()=>{const e=a.current,t=e=>{document.querySelector('.dictation-feedback[data-screen="results"]')||(l.current=e.touches[0].clientX,i.current=e.touches[0].clientY)},r=e=>{var t,r;if(!e.changedTouches||!e.changedTouches[0])return;const n=e.changedTouches[0].clientX,c=e.changedTouches[0].clientY,s=n-l.current,a=c-i.current;if(document.querySelector('.dictation-feedback[data-screen="results"]'))return;let u=e.target,h=!1;for(;u&&u!==document;){if(u.tagName&&"textarea"===u.tagName.toLowerCase()){h=!0;break}if(!u.parentNode)break;u=u.parentNode}if(!h&&(Math.abs(s)>1.5*Math.abs(a)&&Math.abs(s)>50&&(console.log("Horizontal swipe detected:",s>0?"right":"left"),s>0?(console.log("Swipe right - next sentence"),o.current&&"function"==typeof o.current.goToNextSentence&&(o.current.goToNextSentence(!0),d("Next sentence"),o.current.pauseAudio&&o.current.pauseAudio())):(console.log("Swipe left - previous sentence"),o.current&&"function"==typeof o.current.handlePreviousSentence&&(o.current.handlePreviousSentence(),d("Previous sentence"),o.current.pauseAudio&&o.current.pauseAudio()))),Math.abs(a)>1.5*Math.abs(s)&&Math.abs(a)>50))if(console.log("Vertical swipe detected:",a>0?"down":"up"),a<0){if(console.log("Swipe up - repeat sentence"),o.current){console.log("Available methods:",Object.keys(o.current));try{if("function"==typeof o.current.repeatCurrentSentence)o.current.repeatCurrentSentence(),d("Repeat sentence");else if("function"==typeof(null==(r=null==(t=o.current.audioRef)?void 0:t.current)?void 0:r.play)){const e=o.current.audioRef.current;e.currentTime=0,e.play(),d("Repeat sentence")}else console.error("No repeat function available")}catch(p){console.error("Error repeating sentence:",p)}}}else if(console.log("Swipe down - change playback speed"),o.current)try{const e=document.querySelector("audio");if(e){const t=e.playbackRate;let r;console.log("Current audio speed:",t),Math.abs(t-1)<.1?(r=.75,d("Speed: 75%")):Math.abs(t-.75)<.1?(r=.5,d("Speed: 50%")):(r=1,d("Speed: 100%")),console.log("Setting new speed to:",r),e.playbackRate=r,setTimeout((()=>{console.log("Speed after change:",e.playbackRate)}),100),"function"==typeof o.current.changePlaybackSpeed&&o.current.changePlaybackSpeed(r),e.volume=e.volume}else if(console.error("No audio element found in the DOM"),"function"==typeof o.current.changePlaybackSpeed)if(o.current.changePlaybackSpeed(),o.current.getCurrentSpeed){const e=o.current.getCurrentSpeed();d("Speed: "+e+"%")}else d("Speed changed")}catch(p){console.error("Error changing playback speed:",p)}};return e&&(e.addEventListener("touchstart",t),e.addEventListener("touchend",r)),()=>{e&&(e.removeEventListener("touchstart",t),e.removeEventListener("touchend",r))}}),[]);return j.jsxs("div",{className:"mobile-dictation-container",ref:a,style:F.container,children:[j.jsx("div",{className:"mobile-dictation-content",style:F.content,children:j.jsx(B,{...t,ref:o,audioPlayerOverride:{component:z,additionalProps:{onStartDictation:h,onCancel:p}},isMobile:!0,hideShortcuts:!0})}),c&&j.jsx("div",{style:F.feedback,children:c})]})},U=({exerciseId:t,embeddedExercise:r,embedded:n=!1,...c})=>{const{isMobile:s}=(()=>{const t=e.useContext(_);if(void 0===t)throw new Error("useResponsive must be used within a ResponsiveProvider");return t})(),[o,a]=e.useState(!1),{isEmbedded:l}=m();e.useEffect((()=>{const e=()=>{a(!0)};return document.addEventListener("exerciseStarted",e),l&&window.parent&&window.parent!==window&&window.parent.postMessage({type:"DICTATION_APP_READY",height:document.documentElement.scrollHeight},"*"),()=>{document.removeEventListener("exerciseStarted",e)}}),[l]);const i={...c,customExercise:r};return n&&r?j.jsx(D,{exerciseId:t,embeddedExercise:r,...c}):s?j.jsx("div",{className:"mobile-wrapper",children:j.jsx(W,{children:j.jsx(H,{...i,isMobile:!0})})}):j.jsx(B,{...i,isMobile:!1})};function X({embedded:t=!1}){const[r,n]=e.useState(1),[c,s]=e.useState(!1),[o,a]=e.useState(null),[l,i]=e.useState(!1),[u,d]=e.useState(null);return e.useEffect((()=>{const e=m();(t||e.isEmbedded)&&(i(!0),f(e.vttUrl).then((e=>{a(e),d(null)})).catch((e=>{console.error("Error loading embedded exercise:",e),d("Failed to load dictation exercise. Please check your connection and try again.")})).finally((()=>{i(!1)})))}),[t]),j.jsx(O,{children:j.jsx("div",{className:"app",children:j.jsx("main",{className:"app-content",children:l?j.jsx("div",{className:"loading",children:"Loading dictation exercise..."}):u?j.jsx("div",{className:"error-message",children:u}):j.jsx(U,{exerciseId:r,embeddedExercise:o,embedded:t,onCancel:()=>{console.log("Cancel handler from App component"),s(!0)}})})})})}export{X as A,S as c,j};
//# sourceMappingURL=index-c6679c2b.js.map
