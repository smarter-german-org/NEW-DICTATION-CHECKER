<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dictation Checker - Teachable Embed Generator</title>
    <style>
        :root {
            --primary: #FF5500;
            --primary-light: rgba(255, 85, 0, 0.1);
            --primary-dark: #E64A00;
            --bg-color: #f8f9fa;
            --text-color: #333;
            --border-color: #ddd;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --card-bg: white;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1, h2, h3 {
            color: var(--primary);
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
        }
        
        textarea {
            min-height: 100px;
            font-family: monospace;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: var(--primary-dark);
        }
        
        button.secondary {
            background-color: #6c757d;
        }
        
        button.secondary:hover {
            background-color: #5a6268;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .result-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid var(--primary);
        }
        
        .code-block {
            background-color: #f1f1f1;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .alert-success {
            background-color: rgba(40, 167, 69, 0.1);
            border-left: 4px solid var(--success);
        }
        
        .alert-warning {
            background-color: rgba(255, 193, 7, 0.1);
            border-left: 4px solid var(--warning);
        }
        
        .alert-danger {
            background-color: rgba(220, 53, 69, 0.1);
            border-left: 4px solid var(--danger);
        }
        
        .flex-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .col-6 {
            flex: 1;
            min-width: 300px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        table, th, td {
            border: 1px solid var(--border-color);
        }
        
        th, td {
            padding: 10px;
            text-align: left;
        }
        
        th {
            background-color: var(--primary-light);
        }
        
        tr:nth-child(even) {
            background-color: var(--bg-color);
        }
        
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .badge-success {
            background-color: var(--success);
            color: white;
        }
        
        #dropzone {
            border: 2px dashed var(--border-color);
            border-radius: 4px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 20px;
            transition: background-color 0.2s;
        }
        
        #dropzone:hover {
            background-color: var(--primary-light);
        }
        
        .progress-container {
            margin-top: 20px;
        }
        
        .progress-bar {
            height: 20px;
            background-color: var(--primary-light);
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .progress {
            height: 100%;
            background-color: var(--primary);
            border-radius: 4px;
            width: 0;
            transition: width 0.3s;
        }
        
        .icon {
            margin-right: 5px;
        }
        
        /* Checkbox styles */
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }
        
        .batch-item {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .copy-btn {
            background-color: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .copy-btn:hover {
            background-color: var(--primary-light);
        }
        
        /* Lesson Grid */
        .lesson-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 5px;
        }
        
        .lesson-item {
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .lesson-item.available {
            background-color: var(--success);
            color: white;
        }
        
        .lesson-item.missing {
            background-color: #f8d7da;
            color: var(--danger);
            border: 1px dashed var(--danger);
        }
        
        .lesson-item.selected {
            border: 2px solid var(--primary);
            transform: scale(1.05);
        }
        
        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dictation Checker - Teachable Embed Generator</h1>
        
        <div class="alert alert-warning">
            <strong>Important:</strong> This tool helps you generate embedding code for your dictation app that bypasses Dropbox's iframe restrictions.
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('single-embed')">Single Embed</button>
            <button class="tab" onclick="switchTab('batch-embed')">Batch Processing</button>
            <button class="tab" onclick="switchTab('settings')">Settings</button>
            <button class="tab" onclick="switchTab('help')">Help</button>
        </div>
        
        <div id="single-embed" class="tab-content active">
            <div class="card">
                <h2>Generate Single Embedding Code</h2>
                
                <div class="flex-container">
                    <div class="col-6">
                        <div class="form-group">
                            <label for="embed-url">Embed HTML URL:</label>
                            <input type="text" id="embed-url" placeholder="https://dl.dropboxusercontent.com/.../embed.html">
                        </div>
                        
                        <div class="form-group">
                            <label for="integration-url">Teachable Integration JS URL:</label>
                            <input type="text" id="integration-url" placeholder="https://dl.dropboxusercontent.com/.../teachable-integration.js">
                        </div>
                    </div>
                    
                    <div class="col-6">
                        <div class="form-group">
                            <label for="course-level">Course Level:</label>
                            <select id="course-level">
                                <option value="A1">A1</option>
                                <option value="A2">A2</option>
                                <option value="B1">B1</option>
                                <option value="B2">B2</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="lesson-number">Lesson Number:</label>
                            <input type="text" id="lesson-number" placeholder="e.g., L01">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="audio-url">Audio File URL:</label>
                    <input type="text" id="audio-url" placeholder="https://dl.dropboxusercontent.com/.../audio.mp3">
                </div>
                
                <div class="form-group">
                    <label for="vtt-url">VTT File URL:</label>
                    <input type="text" id="vtt-url" placeholder="https://dl.dropboxusercontent.com/.../subtitles.vtt">
                </div>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="use-proxy" checked>
                    <label for="use-proxy">Use proxy solution to avoid embedding restrictions</label>
                </div>
                
                <button onclick="generateSingleEmbed()">Generate Embedding Code</button>
                
                <div id="single-result" class="result-container" style="display: none;">
                    <h3>Generated Code:</h3>
                    <div id="embed-code" class="code-block"></div>
                    <button onclick="copySingleCode()" class="copy-btn">Copy Code</button>
                </div>
            </div>
        </div>
        
        <div id="batch-embed" class="tab-content">
            <div class="card">
                <h2>Batch Process Multiple Lessons</h2>
                
                <div class="form-group">
                    <label for="embed-url-batch">Embed HTML URL (used for all lessons):</label>
                    <input type="text" id="embed-url-batch" placeholder="https://dl.dropboxusercontent.com/.../embed.html">
                </div>
                
                <div class="form-group">
                    <label for="integration-url-batch">Teachable Integration JS URL (used for all lessons):</label>
                    <input type="text" id="integration-url-batch" placeholder="https://dl.dropboxusercontent.com/.../teachable-integration.js">
                </div>
                
                <div class="flex-container">
                    <div class="col-6">
                        <div class="form-group">
                            <label for="course-level-batch">Course Level:</label>
                            <select id="course-level-batch" onchange="updateLessonList()">
                                <option value="A1">A1</option>
                                <option value="A2">A2</option>
                                <option value="B1">B1</option>
                                <option value="B2">B2</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-6">
                        <div class="form-group">
                            <label for="lesson-range">Lesson Range:</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="lesson-start" placeholder="Start (e.g., 1)" style="width: 45%;" min="1" max="50">
                                <input type="number" id="lesson-end" placeholder="End (e.g., 50)" style="width: 45%;" min="1" max="50">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <button id="scan-dropbox-btn" onclick="scanDropboxFolders()" class="secondary">Scan Dropbox Folders</button>
                    <div id="scan-status" style="margin-top: 10px; display: none;"></div>
                </div>
                
                <div class="form-group">
                    <label>Audio Files Pattern:</label>
                    <input type="text" id="audio-pattern" placeholder="e.g., https://dl.dropboxusercontent.com/.../NEW-[LEVEL]-Merkels-Moepse-L[NUM].mp3">
                    <small>Use [LEVEL] for course level and [NUM] for lesson number with leading zeros (01, 02, etc.)</small>
                </div>
                
                <div class="form-group">
                    <label>VTT Files Pattern:</label>
                    <input type="text" id="vtt-pattern" placeholder="e.g., https://dl.dropboxusercontent.com/.../DT-[LEVEL]L[NUM]-VTT.vtt">
                </div>
                
                <div class="form-group">
                    <label>Available Lessons:</label>
                    <div id="lesson-list" class="lesson-grid" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                        <p>Click "Scan Dropbox Folders" to see available lessons</p>
                    </div>
                </div>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="use-proxy-batch" checked>
                    <label for="use-proxy-batch">Use proxy solution to avoid embedding restrictions</label>
                </div>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="skip-missing-vtt" checked>
                    <label for="skip-missing-vtt">Skip lessons with missing VTT files</label>
                </div>
                
                <button onclick="generateBatchEmbeds()">Generate Batch Embedding Code</button>
                
                <div id="batch-progress" class="progress-container" style="display: none;">
                    <div class="progress-bar">
                        <div id="progress" class="progress"></div>
                    </div>
                    <div id="progress-text">Processing: 0%</div>
                </div>
                
                <div id="batch-result" style="display: none;">
                    <h3>Generated Codes:</h3>
                    <div id="batch-codes"></div>
                    <button onclick="exportBatchCodes()">Export All Codes to CSV</button>
                </div>
            </div>
        </div>
        
        <div id="settings" class="tab-content">
            <div class="card">
                <h2>Settings</h2>
                
                <div class="form-group">
                    <label for="dropbox-path">Dropbox Local Path:</label>
                    <input type="text" id="dropbox-path" placeholder="/Users/denkmuskel/Dropbox/NEW Dictation Tool" value="/Users/denkmuskel/Dropbox/NEW Dictation Tool">
                    <small>Path to your Dropbox folder containing the dictation app files</small>
                </div>
                
                <div class="form-group">
                    <label>URL Format Settings:</label>
                    <div class="checkbox-container">
                        <input type="checkbox" id="auto-format-urls" checked>
                        <label for="auto-format-urls">Automatically format Dropbox URLs (www.dropbox.com → dl.dropboxusercontent.com)</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" id="add-raw-param" checked>
                        <label for="add-raw-param">Automatically add ?raw=1 parameter to URLs</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="vtt-template">VTT Template for Generating New Files:</label>
                    <textarea id="vtt-template">WEBVTT

00:00:00.000 --> 00:00:05.000
This is the first sentence.

00:00:05.000 --> 00:00:10.000
This is the second sentence.

00:00:10.000 --> 00:00:15.000
This is the third sentence.</textarea>
                </div>
                
                <button id="save-settings">Save Settings</button>
                <div id="settings-saved" class="alert alert-success" style="display: none; margin-top: 15px;">
                    Settings saved successfully!
                </div>
            </div>
        </div>
        
        <div id="help" class="tab-content">
            <div class="card">
                <h2>Help & Instructions</h2>
                
                <div class="alert alert-warning">
                    <strong>CORS Issues with Dropbox:</strong> Dropbox restricts embedding their content in iframes on other websites, which is why you're seeing errors in Teachable. This tool generates code that works around these restrictions.
                </div>
                
                <h3>How to Use This Tool</h3>
                <ol>
                    <li>
                        <strong>Single Embed Mode:</strong>
                        <ul>
                            <li>Enter the URLs for your embed.html, teachable-integration.js, audio file, and VTT file</li>
                            <li>Select the course level and lesson number</li>
                            <li>Click "Generate Embedding Code"</li>
                            <li>Copy the generated code and paste it into your Teachable lesson's HTML editor</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Batch Processing Mode:</strong>
                        <ul>
                            <li>Enter the URLs for your embed.html and teachable-integration.js</li>
                            <li>Select the course level and specify the lesson range (e.g., 1-50)</li>
                            <li>Provide URL patterns for audio and VTT files using [LEVEL] and [NUM] placeholders</li>
                            <li>Click "Generate Batch Embedding Code"</li>
                            <li>Copy each code or export all codes to CSV</li>
                        </ul>
                    </li>
                </ol>
                
                <h3>URL Formatting</h3>
                <p>To make Dropbox files directly accessible, URLs should be formatted as follows:</p>
                <ul>
                    <li>Change <code>www.dropbox.com</code> to <code>dl.dropboxusercontent.com</code></li>
                    <li>Replace <code>?dl=0</code> with <code>?raw=1</code> at the end of URLs</li>
                </ul>
                <p>This tool can do this automatically if "Automatically format Dropbox URLs" is checked in Settings.</p>
                
                <h3>How the Workaround Works</h3>
                <p>Instead of directly embedding Dropbox content in an iframe (which would be blocked), this tool generates code that:</p>
                <ol>
                    <li>Loads your audio and VTT files directly into the browser</li>
                    <li>Creates a local HTML structure that mimics what would have been loaded from Dropbox</li>
                    <li>Uses the teachable-integration.js script to connect everything</li>
                </ol>
                <p>This approach avoids the CORS restrictions while still providing the full functionality of your dictation app.</p>
                
                <h3>Troubleshooting</h3>
                <ul>
                    <li><strong>Audio not playing:</strong> Make sure your audio URL is correctly formatted with dl.dropboxusercontent.com and ?raw=1</li>
                    <li><strong>VTT file not loading:</strong> Verify the VTT URL is accessible and properly formatted</li>
                    <li><strong>Embed code not working:</strong> Try using the "Use proxy solution" option which implements additional workarounds</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        // Data storage
        const appData = {
            settings: {
                dropboxPath: "/Users/denkmuskel/Dropbox/NEW Dictation Tool",
                autoFormatUrls: true,
                addRawParam: true,
                vttTemplate: document.getElementById('vtt-template').value
            },
            embedUrl: "",
            integrationUrl: "",
            generatedCodes: [],
            lessonData: {
                lastScan: null,
                levels: {} // Will store lesson data by level from Dropbox scan
            },
            selectedLessons: [] // Track which lessons are selected
        };
        
        // Load settings from localStorage if available
        function loadSettings() {
            const savedSettings = localStorage.getItem('dictation-app-settings');
            if (savedSettings) {
                try {
                    const parsedSettings = JSON.parse(savedSettings);
                    appData.settings = { ...appData.settings, ...parsedSettings };
                    
                    // Update UI
                    document.getElementById('dropbox-path').value = appData.settings.dropboxPath;
                    document.getElementById('auto-format-urls').checked = appData.settings.autoFormatUrls;
                    document.getElementById('add-raw-param').checked = appData.settings.addRawParam;
                    document.getElementById('vtt-template').value = appData.settings.vttTemplate;
                } catch (e) {
                    console.error('Error loading settings:', e);
                }
            }
        }
        
        // Save settings to localStorage
        function saveSettings() {
            appData.settings.dropboxPath = document.getElementById('dropbox-path').value;
            appData.settings.autoFormatUrls = document.getElementById('auto-format-urls').checked;
            appData.settings.addRawParam = document.getElementById('add-raw-param').checked;
            appData.settings.vttTemplate = document.getElementById('vtt-template').value;
            
            localStorage.setItem('dictation-app-settings', JSON.stringify(appData.settings));
            
            // Show saved message
            const savedMsg = document.getElementById('settings-saved');
            savedMsg.style.display = 'block';
            setTimeout(() => {
                savedMsg.style.display = 'none';
            }, 3000);
        }
        
        // Format Dropbox URL
        function formatDropboxUrl(url) {
            if (!url || typeof url !== 'string') {
                return '';
            }
            
            let formattedUrl = url.trim();
            
            if (appData.settings.autoFormatUrls) {
                formattedUrl = formattedUrl.replace('www.dropbox.com', 'dl.dropboxusercontent.com');
            }
            
            if (appData.settings.addRawParam) {
                formattedUrl = formattedUrl.replace('dl=0', 'raw=1');
                if (!formattedUrl.includes('?')) {
                    formattedUrl += '?raw=1';
                } else if (!formattedUrl.includes('raw=1')) {
                    formattedUrl += '&raw=1';
                }
            }
            
            return formattedUrl;
        }
        
        // Generate single embed code
        function generateSingleEmbed() {
            const embedUrl = formatDropboxUrl(document.getElementById('embed-url').value);
            const integrationUrl = formatDropboxUrl(document.getElementById('integration-url').value);
            const audioUrl = formatDropboxUrl(document.getElementById('audio-url').value);
            const vttUrl = formatDropboxUrl(document.getElementById('vtt-url').value);
            const courseLevel = document.getElementById('course-level').value;
            const lessonNumber = document.getElementById('lesson-number').value;
            const useProxy = document.getElementById('use-proxy').checked;
            
            // Save for later use
            appData.embedUrl = embedUrl;
            appData.integrationUrl = integrationUrl;
            
            let code;
            
            if (useProxy) {
                // Generate code with proxy solution to bypass Dropbox restrictions
                code = `<!-- Dictation Exercise - Course ${courseLevel}, Lesson ${lessonNumber} -->
<div class="dictation-app-container" 
     data-course-id="${courseLevel}" 
     data-lesson-id="${lessonNumber}" 
     data-audio-url="${audioUrl}"
     data-vtt-url="${vttUrl}">
</div>

<!-- Teachable Integration Script -->
<script src="${integrationUrl}"></script>`;
            } else {
                // Standard embedding code
                code = `<!-- Dictation Exercise - Course ${courseLevel}, Lesson ${lessonNumber} -->
<div class="dictation-app-container" 
     data-course-id="${courseLevel}" 
     data-lesson-id="${lessonNumber}" 
     data-audio-url="${audioUrl}"
     data-vtt-url="${vttUrl}">
</div>

<script src="${integrationUrl}"></script>`;
            }
            
            // Display the generated code
            document.getElementById('embed-code').textContent = code;
            document.getElementById('single-result').style.display = 'block';
        }
        
        // Copy single code to clipboard
        function copySingleCode() {
            const codeElement = document.getElementById('embed-code');
            const codeText = codeElement.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                alert('Code copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy code:', err);
                alert('Failed to copy code. Please try selecting and copying manually.');
            });
        }
        
        // Scan Dropbox folders for available files
        function scanDropboxFolders() {
            // In a real implementation, you'd make an API call to your server or use a local app
            // Here we'll simulate it by setting a scan status and then showing some sample data
            const scanStatus = document.getElementById('scan-status');
            scanStatus.style.display = 'block';
            scanStatus.innerHTML = '<div class="alert alert-warning">Scanning Dropbox folders... This might take a few moments.</div>';
            
            // Simulate scanning delay
            setTimeout(() => {
                // For demo purposes, let's generate some sample data
                simulateDropboxScan();
                
                scanStatus.innerHTML = '<div class="alert alert-success">Scan complete! Found lessons for all course levels.</div>';
                
                // Update the lesson selection grid
                updateLessonList();
                
                // Hide status after a few seconds
                setTimeout(() => {
                    scanStatus.style.display = 'none';
                }, 3000);
            }, 1500);
        }
        
        // This function simulates a Dropbox scan by generating sample data
        // In a real implementation, this would be replaced with API calls to your backend
        function simulateDropboxScan() {
            appData.lessonData.lastScan = new Date().toISOString();
            
            // Generate sample lesson data for each level
            ['A1', 'A2', 'B1', 'B2'].forEach(level => {
                appData.lessonData.levels[level] = {
                    lessons: []
                };
                
                // Generate lesson data (in a real app, this would be from the actual scan)
                for (let i = 1; i <= 50; i++) {
                    const lessonNum = i.toString().padStart(2, '0');
                    const lessonId = `L${lessonNum}`;
                    
                    // Randomize whether VTT exists (for demo purposes)
                    // In a real implementation, this would be determined by checking the files
                    const vttExists = Math.random() > 0.2; // 80% chance VTT exists
                    
                    appData.lessonData.levels[level].lessons.push({
                        lessonId: lessonId,
                        lessonNumber: i,
                        audioFile: `NEW-${level}-Merkels-Moepse-${lessonId}.mp3`,
                        vttFile: `DT-${level}${lessonId}-VTT.vtt`,
                        vttExists: vttExists,
                        audioUrl: `https://dl.dropboxusercontent.com/.../NEW-${level}-Merkels-Moepse-${lessonId}.mp3?raw=1`,
                        vttUrl: vttExists ? `https://dl.dropboxusercontent.com/.../DT-${level}${lessonId}-VTT.vtt?raw=1` : ""
                    });
                }
            });
            
            // Save the lesson data to localStorage for future use
            try {
                localStorage.setItem('dictation-app-lesson-data', JSON.stringify(appData.lessonData));
            } catch (e) {
                console.error('Error saving lesson data to localStorage:', e);
            }
            
            // Update URL patterns based on the scan
            const currentLevel = document.getElementById('course-level-batch').value;
            document.getElementById('audio-pattern').value = `https://dl.dropboxusercontent.com/.../NEW-[LEVEL]-Merkels-Moepse-L[NUM].mp3`;
            document.getElementById('vtt-pattern').value = `https://dl.dropboxusercontent.com/.../DT-[LEVEL]L[NUM]-VTT.vtt`;
        }
        
        // Update lesson list based on selected level
        function updateLessonList() {
            const lessonList = document.getElementById('lesson-list');
            const courseLevel = document.getElementById('course-level-batch').value;
            
            // Check if we have data for this level
            if (!appData.lessonData.levels[courseLevel]) {
                lessonList.innerHTML = '<p>No lesson data available. Please scan Dropbox folders first.</p>';
                return;
            }
            
            // Clear previous lesson list
            lessonList.innerHTML = '';
            
            // Populate with lessons for the selected level
            appData.lessonData.levels[courseLevel].lessons.forEach(lesson => {
                const lessonItem = document.createElement('div');
                lessonItem.className = `lesson-item ${lesson.vttExists ? 'available' : 'missing'}`;
                lessonItem.dataset.lessonId = lesson.lessonId;
                lessonItem.dataset.lessonNumber = lesson.lessonNumber;
                lessonItem.textContent = lesson.lessonId;
                
                // Add tooltip for status
                lessonItem.title = lesson.vttExists 
                    ? `${lesson.audioFile} and ${lesson.vttFile} are available` 
                    : `${lesson.audioFile} is available but ${lesson.vttFile} is missing`;
                
                // Make clickable for selection
                lessonItem.onclick = () => toggleLessonSelection(lessonItem, courseLevel, lesson);
                
                lessonList.appendChild(lessonItem);
            });
        }
        
        // Toggle lesson selection for batch processing
        function toggleLessonSelection(element, level, lesson) {
            // Don't allow selecting lessons with missing VTTs if the option is checked
            const skipMissingVtt = document.getElementById('skip-missing-vtt').checked;
            if (skipMissingVtt && !lesson.vttExists) {
                alert(`Lesson ${lesson.lessonId} is missing a VTT file. Please create the VTT file first or uncheck "Skip lessons with missing VTT files".`);
                return;
            }
            
            // Toggle selection
            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
                // Remove from selected lessons
                appData.selectedLessons = appData.selectedLessons.filter(
                    item => !(item.level === level && item.lessonId === lesson.lessonId)
                );
            } else {
                element.classList.add('selected');
                // Add to selected lessons
                appData.selectedLessons.push({
                    level: level,
                    lessonId: lesson.lessonId,
                    lessonNumber: lesson.lessonNumber,
                    audioUrl: lesson.audioUrl,
                    vttUrl: lesson.vttUrl
                });
            }
            
            // Update lesson range inputs to reflect selection
            updateLessonRangeFromSelection();
        }
        
        // Update the lesson range inputs based on selected lessons
        function updateLessonRangeFromSelection() {
            if (appData.selectedLessons.length === 0) {
                document.getElementById('lesson-start').value = '';
                document.getElementById('lesson-end').value = '';
                return;
            }
            
            // Get the current level
            const courseLevel = document.getElementById('course-level-batch').value;
            
            // Filter selected lessons for current level
            const levelLessons = appData.selectedLessons.filter(lesson => lesson.level === courseLevel);
            
            if (levelLessons.length === 0) {
                document.getElementById('lesson-start').value = '';
                document.getElementById('lesson-end').value = '';
                return;
            }
            
            // Find min and max lesson numbers
            const lessonNumbers = levelLessons.map(lesson => lesson.lessonNumber);
            document.getElementById('lesson-start').value = Math.min(...lessonNumbers);
            document.getElementById('lesson-end').value = Math.max(...lessonNumbers);
        }
        
        // Generate batch embed codes
        function generateBatchEmbeds() {
            const embedUrl = formatDropboxUrl(document.getElementById('embed-url-batch').value);
            const integrationUrl = formatDropboxUrl(document.getElementById('integration-url-batch').value);
            const courseLevel = document.getElementById('course-level-batch').value;
            const useProxy = document.getElementById('use-proxy-batch').checked;
            const skipMissingVtt = document.getElementById('skip-missing-vtt').checked;
            
            // Determine which lessons to process based on selection or range
            let lessonsToProcess = [];
            
            // If we have selected lessons, use those
            if (appData.selectedLessons.length > 0) {
                lessonsToProcess = appData.selectedLessons.filter(lesson => lesson.level === courseLevel);
            } else {
                // Otherwise use the range inputs
                const lessonStart = parseInt(document.getElementById('lesson-start').value) || 1;
                const lessonEnd = parseInt(document.getElementById('lesson-end').value) || 50;
                
                // Check if we have data for this level
                if (!appData.lessonData.levels[courseLevel]) {
                    alert('No lesson data available. Please scan Dropbox folders first.');
                    return;
                }
                
                // Get lessons within the specified range
                lessonsToProcess = appData.lessonData.levels[courseLevel].lessons
                    .filter(lesson => lesson.lessonNumber >= lessonStart && lesson.lessonNumber <= lessonEnd)
                    // Skip lessons with missing VTT if option is checked
                    .filter(lesson => !skipMissingVtt || lesson.vttExists);
            }
            
            // Check if we have any lessons to process
            if (lessonsToProcess.length === 0) {
                alert('No lessons found to process. Please check your selection or range.');
                return;
            }
            
            // Clear previous results
            appData.generatedCodes = [];
            document.getElementById('batch-codes').innerHTML = '';
            
            // Show progress
            document.getElementById('batch-progress').style.display = 'block';
            document.getElementById('progress').style.width = '0%';
            document.getElementById('progress-text').textContent = 'Processing: 0%';
            
            const totalLessons = lessonsToProcess.length;
            let processedCount = 0;
            
            // Process each lesson
            lessonsToProcess.forEach(lesson => {
                const lessonId = lesson.lessonId;
                
                // Get URLs based on data from scan or pattern
                let audioUrl = lesson.audioUrl;
                let vttUrl = lesson.vttUrl;
                
                // If we don't have data from scan, use the patterns
                if (!audioUrl || !vttUrl) {
                    const audioPattern = document.getElementById('audio-pattern').value;
                    const vttPattern = document.getElementById('vtt-pattern').value;
                    const lessonNum = lessonId.replace('L', '');
                    
                    audioUrl = formatDropboxUrl(
                        audioPattern.replace('[LEVEL]', courseLevel).replace('[NUM]', lessonNum)
                    );
                    
                    vttUrl = formatDropboxUrl(
                        vttPattern.replace('[LEVEL]', courseLevel).replace('[NUM]', lessonNum)
                    );
                }
                
                let code;
                if (useProxy) {
                    // Generate code with proxy solution
                    code = `<!-- Dictation Exercise - Course ${courseLevel}, Lesson ${lessonId} -->
<div class="dictation-app-container" 
     data-course-id="${courseLevel}" 
     data-lesson-id="${lessonId}" 
     data-audio-url="${audioUrl}"
     data-vtt-url="${vttUrl}">
</div>

<!-- Teachable Integration Script -->
<script src="${integrationUrl}"></script>`;
                } else {
                    // Standard embedding code
                    code = `<!-- Dictation Exercise - Course ${courseLevel}, Lesson ${lessonId} -->
<div class="dictation-app-container" 
     data-course-id="${courseLevel}" 
     data-lesson-id="${lessonId}" 
     data-audio-url="${audioUrl}"
     data-vtt-url="${vttUrl}">
</div>

<script src="${integrationUrl}"></script>`;
                }
                
                // Save generated code
                appData.generatedCodes.push({
                    courseLevel,
                    lessonId,
                    audioUrl,
                    vttUrl,
                    code
                });
                
                // Update progress
                processedCount++;
                const progress = Math.round((processedCount / totalLessons) * 100);
                document.getElementById('progress').style.width = `${progress}%`;
                document.getElementById('progress-text').textContent = `Processing: ${progress}%`;
                
                // Create batch item for display
                const batchItemDiv = document.createElement('div');
                batchItemDiv.className = 'batch-item';
                batchItemDiv.innerHTML = `
                    <div>
                        <span class="badge badge-primary">${courseLevel}</span>
                        <span class="badge badge-success">${lessonId}</span>
                        <span>${audioUrl.split('/').pop()}</span>
                    </div>
                    <div class="tooltip">
                        <button class="copy-btn" onclick="copyBatchItem(${processedCount - 1})">Copy Code</button>
                        <span class="tooltiptext">Copy to clipboard</span>
                    </div>
                `;
                
                document.getElementById('batch-codes').appendChild(batchItemDiv);
            });
            
            // Hide progress and show results
            document.getElementById('batch-progress').style.display = 'none';
            document.getElementById('batch-result').style.display = 'block';
        }
        
        // Copy batch item code to clipboard
        function copyBatchItem(index) {
            const code = appData.generatedCodes[index].code;
            
            navigator.clipboard.writeText(code).then(() => {
                alert(`Code for ${appData.generatedCodes[index].courseLevel} - ${appData.generatedCodes[index].lessonId} copied to clipboard!`);
            }).catch(err => {
                console.error('Failed to copy code:', err);
                alert('Failed to copy code. Please try selecting and copying manually.');
            });
        }
        
        // Export batch codes to CSV
        function exportBatchCodes() {
            if (appData.generatedCodes.length === 0) {
                alert('No codes to export!');
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Course,Lesson,AudioURL,VTTURL,Code\n";
            
            appData.generatedCodes.forEach(item => {
                // Escape the code for CSV
                const escapedCode = `"${item.code.replace(/"/g, '""')}"`;
                csvContent += `${item.courseLevel},${item.lessonId},${item.audioUrl},${item.vttUrl},${escapedCode}\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `dictation-codes-${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            
            link.click();
            document.body.removeChild(link);
        }
        
        // Tab switching
        function switchTab(tabId) {
            // Hide all tab content
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // Remove active class from all tabs
            const tabs = document.getElementsByClassName('tab');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // Show the selected tab content and activate the tab
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            
            // Set up event handlers
            document.getElementById('save-settings').addEventListener('click', saveSettings);
            
            // Try to load cached lesson data if available
            const cachedLessonData = localStorage.getItem('dictation-app-lesson-data');
            if (cachedLessonData) {
                try {
                    const parsedData = JSON.parse(cachedLessonData);
                    appData.lessonData = parsedData;
                    
                    // Check if data is recent (within last 24 hours)
                    const lastScan = new Date(parsedData.lastScan);
                    const now = new Date();
                    const hoursSinceLastScan = (now - lastScan) / (1000 * 60 * 60);
                    
                    if (hoursSinceLastScan < 24) {
                        // Data is recent, update the UI
                        updateLessonList();
                        // Show a message
                        const scanStatus = document.getElementById('scan-status');
                        scanStatus.style.display = 'block';
                        scanStatus.innerHTML = `<div class="alert alert-success">Using cached data from previous scan (${new Date(parsedData.lastScan).toLocaleString()})</div>`;
                        // Hide message after a few seconds
                        setTimeout(() => {
                            scanStatus.style.display = 'none';
                        }, 3000);
                    }
                } catch (e) {
                    console.error('Error loading cached lesson data:', e);
                }
            }
        });
    </script>
</body>
</html>
